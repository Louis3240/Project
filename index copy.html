<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Stone-Skipping</title>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js"></script>

    <!-- 引用他人產生漣漪效果的JS -->
    <script src="watercanvas.js"></script>

    <style>
        canvas {
            /* margin: auto;
            display: block; */
            position: absolute;
            left: 0;
            top: 0;
            border: 1px solid black;
            z-index: 10;
        }

        div {
            position: absolute;
            left: 0;
            top: 0;
            z-index: 1;
        }
    </style>

</head>

<body onload="init();">


    <div id="waterHolder"></div>
    <!-- 畫布寬288高512 -->
    <canvas id="myCanvas" width="288" height="512"></canvas>

    <script>
        //漣漪效果的動畫(來源：https://code.almeros.com/water-ripple-canvas-and-javascript/)
        var pixel = create2DArray(createRadialCanvas(2, 2));
        var raindrop = create2DArray(createRadialCanvas(4, 4));
        var finger = create2DArray(createRadialCanvas(50, 50));

        var width = 288;
        var height = 512;

        function init() {
            // Init the basic components
            var waterModel = new WaterModel(width, height, {
                resolution: 3.0,
                interpolate: false,
                damping: 0.985,
                clipping: 5,
                evolveThreshold: 0.05,
                maxFps: 50,
                showStats: true
            });
            var waterCanvas = new WaterCanvas(width, height, "waterHolder", waterModel, {
                backgroundImageUrl: null,
                lightRefraction: 9.0,
                lightReflection: 0.1,
                showStats: true
            });


            // Init some utils
            var rainMaker = new RainMaker(width, height, waterModel, raindrop);
            rainMaker.setRaindropsPerSecond(0);

            // enableMouseInteraction(waterModel, "myCanvas");

            var array2d = [
                [0.5, 1.0, 0.5],
                [1.0, 1.0, 1.0],
                [0.5, 1.0, 0.5]
            ];








            // 以下是自己的project

            //Canvas起手
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");

            // // 背景先用單一背景****
            // var grd = ctx.createLinearGradient(0, 0, 0, 640);
            // // 透明度
            // ctx.globalAlpha = 0.7;
            // grd.addColorStop(0, "blue");
            // grd.addColorStop(0.45, "#00cccc");
            // grd.addColorStop(0.9, "aqua");
            // grd.addColorStop(1, "white");

            // ctx.fillStyle = "aqua";
            // ctx.fillRect(0, 0, 288, 512);



            // 石頭的屬性
            var stone = {
                X: 144,
                Y: 400,
                LowY: 400,  //最低點
                TopY: 380,  //最高點
                RX: 60,
                RY: 20,
                VX: 0,
                VY: 0,  //決定石頭浮動速率
                VZ: 0,  //石頭剛開始出去的移動速率
            };

            // 做一個全域變數，方便在各個函式裡使用。因為要判斷石頭落水後，減速，但是事實上是背景在動。
            var moveSpeed = 2;

            //畫個石頭
            function drawStone(scale) {

                // 畫陰影或反射(一接觸水面時消失)
                if (stone.Y >= stone.TopY && stone.Y <= stone.LowY) {
                    ctx.beginPath();
                    ctx.globalAlpha = 0.8;
                    ctx.fillStyle = "grey";
                    ctx.ellipse(stone.X + 10, stone.Y + 10, stone.RX * (0.9 - scale), stone.RY * (0.9 - scale), 0, 0, Math.PI * 2);
                    ctx.fill();
                }


                //真的石頭
                ctx.beginPath();
                ctx.globalAlpha = 1;
                ctx.fillStyle = "grey";
                ctx.ellipse(stone.X, stone.Y, stone.RX * (1 + scale), stone.RY * (1 + scale), 0, 0, Math.PI * 2);
                ctx.fill();

            }



            //必要完成：開始遊戲/結束遊戲、加速度問題、各種量條(像是高度)、顯示介面(分數、彈跳數、距離)、噴水(碰觸水面)、是否要做可以左右移動(optional)

            //非必要，但期許要做：各種顏色選色、逼真的問題(浪、空間軸的訂定)

            // 石頭跳動的感覺
            function stoneJump() {
                drawStone((stone.LowY - stone.Y) * 0.2 / (stone.LowY - stone.TopY));  //依照石頭達到的高度去做比例放大

                if (stone.Y < stone.TopY)
                    stone.VY = Math.abs(stone.VY);
                else if (stone.Y > stone.LowY) {
                    stone.VY = -Math.abs(stone.VY * 1);
                    stone.TopY = (stone.LowY - stone.TopY) * 0.2 + stone.TopY
                    waterModel.touchWater(144, 300, 1000, array2d);

                    // 彈跳降速****
                    moveSpeed -= 0.2 * moveSpeed;
                }

                if (stone.Y <= 300)
                    stone.VZ = 0;

                if (stone.VZ > 0) {
                    stone.Y -= stone.VZ;
                    stone.LowY = stone.Y;
                    stone.TopY = stone.Y - 20;
                }
                else {
                    stone.Y += stone.VY;
                    stone.LowY = 300
                    stone.TopY = 300 - 20;
                }

            }

            // var start = setInterval(stoneJump, 1000 / 24);

            // 海浪的物件
            function wave(x, y, shape, tier) {
                this.X = x;
                this.Y = y;
                this.tier = Math.ceil(Math.random() * 3)
                //海浪有兩種可以切換
                if (Math.random() < 0.5)
                    this.shape = "﹌".repeat(Math.floor(Math.random() * 3 + 3))
                else
                    this.shape = "﹋".repeat(Math.floor(Math.random() * 3 + 3))
            }

            // 用prototype共用畫WAVE
            wave.prototype.drawWave = function () {
                ctx.fillStyle = "black";
                ctx.font = "35px Arial"
                ctx.fillText(this.shape, this.X, this.Y);
                if (this.tier > 1)
                    ctx.fillText(this.shape, this.X, this.Y + 10);
                if (this.tier > 2)
                    ctx.fillText(this.shape, this.X, this.Y + 20);
            };

            // 浪的預備工作，需要先至少三道
            waveList = [];

            for (var i = 0; i < 3; i++) {
                //海浪的水平位移也是隨機
                waveList.push(new wave(Math.random() * 200, 100 * i));
                waveList[i].drawWave();
            }

            function testWave() {

                //讓畫面上保留隨機的波浪數(最低要為7個)
                if ((waveList.length < 7 || Math.random() < 0.005) && waveList[0].Y > 100)
                    waveList.unshift(new wave(Math.random() * 200, -Math.random() * 100));

                waveList.forEach(function (item, index, array) {
                    //這邊先暫定海浪移動速度是1****，將來要看石頭的移動速度!!
                    item.Y += moveSpeed;
                    item.drawWave();
                })

                if (waveList[waveList.length - 1].Y > 520) {
                    waveList.pop();

                }
            }

            //全域變數距離跟彈跳數，不會被重新宣告
            var dist = 0;
            var bounce = 0;
            //分數顯示
            function scoreDisplay() {
                dist += Math.round(Math.abs(moveSpeed));

                if (stone.Y > stone.LowY)
                    bounce += 1;
                //距離
                ctx.fillStyle = "white";
                ctx.textAlign = "left";
                ctx.textBaseline = "center";
                ctx.font = "15px Georgia"
                ctx.fillText("Distance :" + dist, 180, 30);

                //彈跳數
                ctx.fillText("Bounce   :" + bounce, 180, 50);


            }


            // 遊戲開始函數
            function proceedGame() {
                ctx.clearRect(0, 0, 288, 512);
                ctx.globalAlpha = 0.5;
                ctx.fillStyle = "aqua";
                ctx.fillRect(0, 0, 288, 512);
                testWave();
                stoneJump();
                scoreDisplay();
                console.log(moveSpeed);
                var start = setTimeout(proceedGame, 1000 / 24);
                
                // 沒速度或高度太低就結束了
                if (moveSpeed < 0.5) {
                    clearTimeout(start);
                    console.log("結束")

                    //成績結算以及重新開始
                    ctx.clearRect(0, 0, 288, 512);

                    ctx.globalAlpha = 0.9;
                    ctx.fillStyle = "#adad85";
                    ctx.fillRect(0, 0, 288, 512);

                    ctx.fillStyle = "white";
                    ctx.textAlign = "left";
                    ctx.textBaseline = "center";

                    //距離
                    ctx.font = "20px Georgia"
                    ctx.fillText("Distance    :" + dist, 20, 190);

                    //彈跳數
                    ctx.fillText("Bounce(×100):" + bounce * 100, 20, 220);

                    //分數標題
                    ctx.textAlign = "center";
                    ctx.font = "25px Impact"
                    ctx.fillText("Score", 144, 150);

                    //重新開始條
                    ctx.beginPath()
                    ctx.fillStyle = "blue";
                    ctx.moveTo(0, 270);
                    ctx.lineTo(288, 270);
                    ctx.moveTo(288, 320);
                    ctx.lineTo(0, 320);
                    ctx.stroke();

                    ctx.font = "35px Comic Sans MS"
                    ctx.fillText("Play again", 144, 305);

                    $("canvas").one("click", function () {
                        dist = 0;
                        bounce = 0;
                        stone.X = 144;
                        stone.Y = 400;
                        stone.LowY = 400;
                        stone.TopY = 380;

                        waveList = [];

                        for (var i = 0; i < 3; i++) {
                            //海浪的水平位移也是隨機
                            waveList.push(new wave(Math.random() * 200, 100 * i));
                            waveList[i].drawWave();
                        }
                        startBar();
                    })


                }
            }

            //箭頭的變數，宣告在裡面失敗了(函數包函數)
            var arrow1x = 15;
            const arrow1StandardVx = 6;
            var arrow1Vx = 5;
            var arrow1y = 430;
            var arrow1Direction = true;
            //開頭丟出石頭量條
            function startBar() {
                //讓箭頭飛
                function arrow1() {
                    ctx.clearRect(0, 0, 288, 512);
                    ctx.globalAlpha = 0.5;
                    ctx.fillStyle = "aqua";
                    ctx.fillRect(0, 0, 288, 512);
                    moveSpeed = 0;
                    drawStone(0);

                    // 漸層量條
                    ctx.globalAlpha = 1.0;
                    var lineargradient = ctx.createLinearGradient(20, 450, 268, 450);
                    lineargradient.addColorStop(0, 'white');
                    lineargradient.addColorStop(0.4, 'green');
                    lineargradient.addColorStop(0.7, 'yellow');
                    lineargradient.addColorStop(1, 'red');
                    ctx.fillStyle = lineargradient;
                    ctx.fillRect(20, 450, 248, 10);

                    //邊框
                    ctx.strokeRect(20, 450, 248, 10)


                    ctx.beginPath();
                    ctx.moveTo(arrow1x, arrow1y);
                    ctx.lineTo(arrow1x + 20, arrow1y);
                    ctx.lineTo(arrow1x + 10, arrow1y + 15);
                    ctx.lineTo(arrow1x, arrow1y);
                    ctx.stroke();

                    if (arrow1x > 258 || arrow1x < 15)
                        arrow1Direction = 1 - arrow1Direction;


                    if (arrow1x < 119.2)
                        arrow1Vx = arrow1StandardVx;
                    else if (arrow1x > 119.2 && arrow1x < 193.6)
                        arrow1Vx = 1.5 * arrow1StandardVx;
                    else if (arrow1x > 193.6)
                        arrow1Vx = 2 * arrow1StandardVx;

                    if (arrow1Direction)
                        arrow1x += arrow1Vx;
                    else
                        arrow1x -= arrow1Vx;

                }

                var startArrow = setInterval(arrow1, 1000 / 24);

                $("canvas").one("click", function () {
                    clearInterval(startArrow);
                    //不同時間點點擊有不同的速度
                    if (arrow1x <= 69.6) {
                        moveSpeed = 2;
                        stone.VZ = 0.4;
                    }
                    else if (arrow1x > 69.6 && arrow1x <= 156.4) {
                        moveSpeed = 3;
                        stone.VZ = 1;
                    }
                    else if (arrow1x > 156.4 && arrow1x <= 230.8) {
                        moveSpeed = 5;
                        stone.VZ = 2;
                    }
                    else {
                        moveSpeed = 8;
                        stone.VZ = 4;
                    }


                    stone.VY = -1.5;

                    //點一下轉去後續進行
                    proceedGame();
                })
            }

            function startGame() {
                //開始遊戲的畫面
                ctx.globalAlpha = 0.9;
                ctx.fillStyle = "#adad85";
                ctx.fillRect(0, 0, 288, 512);
                ctx.beginPath();

                //開始遊戲上下兩條
                ctx.fillStyle = "blue";
                ctx.moveTo(0, 230);
                ctx.lineTo(288, 230);
                ctx.moveTo(288, 280);
                ctx.lineTo(0, 280);
                ctx.stroke();

                //開始遊戲條
                ctx.fillStyle = "black";
                ctx.textAlign = "center";
                ctx.textBaseline = "center";
                ctx.font = "35px Comic Sans MS"
                ctx.fillText("Start Game", 144, 265);

                //跳轉去遊戲開始量條
                $("canvas").one("click", function () {
                    startBar();
                })
            }
            startGame()



        }

    </script>

</body>

</html>